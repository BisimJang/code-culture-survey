<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Code Culture Interactive Form</title>
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    body {
      overflow: hidden;
      font-family: 'Space Grotesk', 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
      transition: background 0.8s ease;
      height: 100vh;
      width: 100vw;
      background: #000;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    .screen::-webkit-scrollbar {
        width: 0;
    }
    .screen {
        -ms-overflow-style: none;
        scrollbar-width: none;
        position: absolute;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        padding: 2rem 1.5rem;
        opacity: 0;
        transition: all 0.8s ease;
        transform: translateX(100%);
        overflow-y: auto;
        overflow-x: hidden;
    }

    .cursor-trail {
      position: fixed;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: currentColor;
      pointer-events: none;
      opacity: 0.3;
      animation: fade-out 0.8s forwards;
      z-index: 9999;
    }

    @keyframes fade-out {
      to { opacity: 0; transform: scale(0); }
    }

    @media (min-width: 768px) {
      .screen {
        padding: 3rem;
      }
    }
    
    .screen.active {
      opacity: 1;
      transform: translate(0, 0);
    }
    
    .screen.exit-left { transform: translateX(-100%); opacity: 0; }
    .screen.exit-right { transform: translateX(100%); opacity: 0; }
    .screen.exit-up { transform: translateY(-100%); opacity: 0; }
    .screen.exit-down { transform: translateY(100%); opacity: 0; }

    .screen.layout-bottom {
      justify-content: flex-end;
      align-items: flex-start;
    }

    .screen.layout-center {
      justify-content: center;
      align-items: center; 
    }
    
    .layout-center .question-text {
        text-align: center;
    }

    .screen.layout-top-bottom {
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .intro-text {
        font-size: clamp(1rem, 3vw, 1.5rem);
        line-height: 1.5;
        margin-bottom: 2rem;
        max-width: 700px;
    }

    .question-text {
      font-size: clamp(1.3rem, 5vw, 3rem);
      font-weight: 700;
      margin-bottom: 1.5rem;
      line-height: 1.2;
      max-width: 100%;
      position: relative;
      z-index: 2;
    }

    @media (min-width: 768px) {
      .question-text {
        margin-bottom: 2rem;
        max-width: 90%;
      }
    }

    .main-content {
        max-width: 700px; 
        width: 100%;
        margin: 0; 
    }
    
    .layout-center .main-content {
        margin: 0 auto;
    }

    .input-row {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: stretch;
      max-width: 100%;
      position: relative;
      z-index: 2;
    }

    @media (min-width: 640px) {
      .input-row {
        flex-direction: row;
        align-items: center;
        max-width: 700px;
      }
    }

    .layout-center .input-row {
      width: 100%;
      justify-content: center;
    }

    input {
      flex: 1;
      padding: 1rem 0;
      font-size: clamp(0.95rem, 3vw, 1.3rem);
      font-family: inherit;
      border: none;
      border-bottom: 3px solid currentColor;
      background: transparent;
      color: inherit;
      outline: none;
      transition: all 0.3s ease;
      min-width: 0;
    }
    
    .input-row input[type="text"], 
    .input-row input[type="email"], 
    .input-row textarea {
        flex: 1;
        padding: 1rem 0;
        font-size: clamp(0.95rem, 3vw, 1.3rem);
        font-family: inherit;
        background: transparent;
        color: inherit;
        outline: none;
        transition: all 0.3s ease;
        min-width: 0;
    }

    .input-row textarea {
        padding: 1rem;
        border: none;
        border-bottom: 3px solid currentColor;
        min-height: 3em;
        resize: none;
        overflow-y: hidden;
    }

    .input-row input[type="text"]:focus, 
    .input-row input[type="email"]:focus, 
    .input-row textarea:focus {
      border-bottom-width: 5px;
      border-color: #22ddd2;
      box-shadow: none;
    }

    input::placeholder, .input-row textarea::placeholder {
      color: inherit;
      opacity: 0.5;
    }

    .nav-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
        width: 100%;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }
    
    @media (max-width: 640px) {
        .nav-buttons {
            max-width: 100%;
        }
    }

    .btn {
      padding: 1rem 2rem;
      font-size: clamp(0.85rem, 2.5vw, 1.1rem);
      font-weight: 700;
      border: 3px solid currentColor;
      background: transparent;
      color: inherit;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 2px;
      white-space: nowrap;
      position: relative;
      overflow: hidden;
      flex: 1;
    }
    
    .validation-message {
        color: #ff3860;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        text-align: center;
        position: absolute;
        bottom: -2rem;
        width: 100%;
    }

    #back-btn {
        opacity: 0.7;
        transition: opacity 0.3s ease;
    }
    #back-btn:hover {
        opacity: 1;
        background: rgba(255,255,255,0.1);
        transform: scale(1.02);
    }
    #back-btn::before {
        content: none !important;
    }

    @media (min-width: 640px) {
      .btn {
        padding: 1rem 2.5rem;
      }
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: currentColor;
      transition: left 0.3s ease;
      z-index: -1;
    }

    .btn:hover::before {
      left: 0;
    }

    .btn:hover {
      color: #000;
      transform: scale(1.05);
    }
    
    #back-btn:hover {
        color: inherit !important;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .options-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.75rem;
      max-width: 100%;
      margin: 1.5rem 0;
      position: relative;
      z-index: 2;
    }

    @media (min-width: 480px) {
      .options-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }
    }

    @media (min-width: 768px) {
      .options-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        max-width: 800px;
        margin: 2rem 0;
      }
    }
    
    .layout-center .options-grid {
        margin-left: auto;
        margin-right: auto;
    }

    .option-btn {
      padding: 1.2rem 1rem;
      font-size: 0.9rem;
      font-weight: 600;
      border: 3px solid currentColor;
      background: rgba(255,255,255,0.05);
      color: inherit;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      -webkit-tap-highlight-color: transparent;
    }

    @media (min-width: 768px) {
      .option-btn {
        padding: 1.5rem;
        font-size: 1rem;
      }
    }

    .option-btn:hover {
      background: rgba(255,255,255,0.15);
      transform: translateY(-5px);
    }

    .option-btn.selected {
      background: currentColor;
      color: #000;
    }

    .progress {
      position: absolute;
      top: 1rem;
      right: 1rem;
      font-size: 0.85rem;
      font-weight: 600;
      opacity: 0.7;
      z-index: 10;
    }

    @media (min-width: 768px) {
      .progress {
        top: 2rem;
        right: 2rem;
        font-size: 1rem;
      }
    }

    .svg-decoration {
      position: absolute;
      pointer-events: none;
      opacity: 0.1;
      z-index: 1;
    }

    #bouncing-ball {
      width: 200px;
      height: 200px;
      margin: 1.5rem auto;
      display: block;
    }

    @media (min-width: 768px) {
      #bouncing-ball {
        width: 300px;
        height: 300px;
        margin: 2rem auto;
      }
    }

    .ball {
      animation: bounce 1s ease-in-out infinite;
      transform-origin: center;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0) scaleY(1); }
      50% { transform: translateY(-80px) scaleY(1.1); }
      90% { transform: translateY(0) scaleY(0.9); }
    }

    .results {
      max-width: 900px;
      overflow-y: auto;
      max-height: 85vh;
      padding-bottom: 2rem;
      position: relative;
      z-index: 2;
    }
    
    .api-error-banner {
        padding: 0.75rem;
        margin-top: 1rem;
        background: rgba(255, 0, 0, 0.2);
        border: 1px solid #ff3860;
        border-radius: 8px;
        font-size: 0.9rem;
        text-align: left;
        display: none;
    }

    .result-header {
      font-size: clamp(2.5rem, 6vw, 4rem);
      font-weight: 900;
      margin-bottom: 2rem;
      background: linear-gradient(45deg, currentColor, rgba(255,255,255,0.6));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .personality-result {
      font-size: clamp(1.8rem, 4vw, 2.5rem);
      font-weight: 800;
      padding: 2rem;
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      margin: 2rem 0;
      border: 3px solid currentColor;
      text-align: center;
      backdrop-filter: blur(10px);
    }

    .answer-block {
      background: rgba(255,255,255,0.05);
      padding: 1.5rem;
      border-radius: 15px;
      margin-bottom: 1rem;
      border-left: 5px solid currentColor;
      backdrop-filter: blur(5px);
    }

    .answer-q {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
      opacity: 0.9;
    }

    .answer-a {
      font-size: 1rem;
      line-height: 1.6;
      opacity: 0.8;
    }

    #profile-output {
        border-radius: 10px;
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(5px);
        min-height: 100px;
        text-align: left;
        display: none;
        white-space: pre-wrap;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    @keyframes wave {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    .wave-svg {
      bottom: 0;
      left: 0;
      width: 100%;
      animation: wave 8s ease-in-out infinite;
    }

    .particles {
      top: 0;
      right: 0;
      width: 50%;
      height: 50%;
    }
  </style>
</head>
<body>
  <div id="form-container"></div>

  <script>
    (function() {
      const CONFIG = {
        COLORS: ["#17072b", "#172d67", "#22ddd2", "#2e73ea", "#8c15e9"],
        WEBHOOK_URL: 'https://script.google.com/macros/s/AKfycbxX7eAKpf_yU7hpAzT54Fq50koz6iiI_r4Cm-7D3mWmfopurulU15ZdK5FRgwfTn1A/exec',
        GEMINI_API_URL: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=',
        // PASTE YOUR GEMINI API KEY HERE BETWEEN THE QUOTES:
        API_KEY: "AIzaSyAqNcfQWSYyufS8Z2j732rxJupHRSt0u_M",
        QUESTIONS: [
          { q: "What is your name?", qIndex: 1, type: "input", inputType: "text", layout: "bottom", placeholder: "e.g., Jane Doe", decoration: "particles" },
          { q: "Welcome", type: "intro", layout: "center", decoration: "particles" },
          { q: "What do you define as a creative?", qIndex: 2, type: "input", inputType: "textarea", layout: "top-bottom", placeholder: "Express your understanding of creativity...", decoration: "wave" },
          { q: "What would make a person tech-based in your opinion?", qIndex: 3, type: "input", inputType: "textarea", layout: "top-bottom", placeholder: "What qualities define a 'techy' person?", decoration: "particles" },
          { q: "When you see a new idea, what's your first instinct?", qIndex: 4, type: "options", layout: "center", options: ["How does it work?", "What does it mean?", "How could it be better?"], decoration: "grid" },
          { q: "What is your primary medium of work?", qIndex: 5, type: "input", inputType: "text", layout: "bottom", placeholder: "e.g., Code (VS Code), Design (Figma), Words (Markdown), Visuals (Canva)", decoration: "particles" },
          { q: "How do you prefer to work?", qIndex: 6, type: "options", layout: "bottom", options: ["Solo deep focus", "Collaborative chaos", "Structured sprints", "Flow state freestyle"], decoration: "wave" },
          { q: "Imagine a ball bouncing — what's the first thing you'd change?", qIndex: 7, type: "input", inputType: "text", layout: "center", placeholder: "I'd change the...", showBall: true, decoration: "none" },
          { q: "Do you enjoy brainstorming ideas or executing them more?", qIndex: 8, type: "options", layout: "center", options: ["Brainstorming ideas (Planning)", "Executing them (Doing)"], decoration: "wave" },
          { q: "If you could create anything without limitation, what would it be?", qIndex: 9, type: "input", inputType: "textarea", layout: "top-bottom", placeholder: "Describe your ideal project...", decoration: "grid" },
          { q: "Based on your answers, would you call yourself:", qIndex: 10, type: "options", layout: "center", options: ["A Creative", "A Tech Person", "A Blend of Both", "Still Exploring"], decoration: "particles" },
          { q: "What is your email?", qIndex: 11, type: "email", inputType: "email", layout: "bottom", placeholder: "your@email.com", decoration: "wave" }
        ],
      };

      const ACTUAL_QUESTION_COUNT = 10;

      const state = {
        container: document.getElementById("form-container"),
        index: 0,
        answers: [],
        selectedOption: null,
        currentInput: null,
        currentBg: CONFIG.COLORS[0],
        sessionId: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
        lastTrailTime: 0,
      };

      function getContrastColor(hex) {
        hex = hex.replace("#", "");
        const r = parseInt(hex.substr(0,2),16);
        const g = parseInt(hex.substr(2,2),16);
        const b = parseInt(hex.substr(4,2),16);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        return brightness > 150 ? "#000" : "#fff";
      }

      function createTrail(x, y) {
        const now = Date.now();
        if (now - state.lastTrailTime > 50) {
          const trail = document.createElement('div');
          trail.className = 'cursor-trail';
          trail.style.left = x + 'px';
          trail.style.top = y + 'px';
          trail.style.color = state.currentBg;
          document.body.appendChild(trail);
          setTimeout(() => trail.remove(), 800);
          state.lastTrailTime = now;
        }
      }

      function createDecoration(type, color) {
        if (type === "wave") {
          return `<svg class="svg-decoration wave-svg" viewBox="0 0 1440 320">
            <path fill="${color}" fill-opacity="0.3" d="M0,160L48,144C96,128,192,96,288,90.7C384,85,480,107,576,128C672,149,768,171,864,165.3C960,160,1056,128,1152,122.7C1248,117,1344,139,1392,149.3L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
          </svg>`;
        } else if (type === "particles") {
          let particles = '<svg class="svg-decoration particles" viewBox="0 0 200 200">';
          for (let i = 0; i < 20; i++) {
            const x = Math.random() * 200;
            const y = Math.random() * 200;
            const r = Math.random() * 3 + 1;
            particles += `<circle cx="${x}" cy="${y}" r="${r}" fill="${color}" opacity="0.4"/>`;
          }
          particles += '</svg>';
          return particles;
        } else if (type === "grid") {
          return `<svg class="svg-decoration" style="top:0;left:0;width:100%;height:100%;" viewBox="0 0 100 100">
            <defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse">
              <path d="M 10 0 L 0 0 0 10" fill="none" stroke="${color}" stroke-width="0.5" opacity="0.2"/>
            </pattern></defs>
            <rect width="100" height="100" fill="url(#grid)" />
          </svg>`;
        }
        return "";
      }
      
      function isValidEmail(email) {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return emailRegex.test(email);
      }

      async function saveResponses(personality) {
        try {
          const name = state.answers[0] || 'Guest';

          const responseData = {
            sessionId: state.sessionId,
            timestamp: new Date().toISOString(),
            name: name,
            personality: personality,
            email: state.answers[CONFIG.QUESTIONS.length - 1],
            answers: {}
          };
          
          CONFIG.QUESTIONS.forEach((q, idx) => {
            if (q.type !== 'intro' && idx < CONFIG.QUESTIONS.length - 1) { 
                responseData.answers[`q${q.qIndex}`] = {
                  question: q.q,
                  answer: state.answers[idx]
                };
            }
          });

          const response = await fetch(CONFIG.WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            mode: 'no-cors', 
            body: JSON.stringify(responseData)
          });
          
          console.log('Attempted to send response to Google Apps Script. Check Sheet for confirmation.');

        } catch (error) {
          console.error('Error saving response:', error);
        }
      }

      async function fetchGemini(payload, maxRetries = 5, delay = 1000) {
          const key = "AIzaSyAqNcfQWSYyufS8Z2j732rxJupHRSt0u_M";
          if (!key) {
              throw new Error("Gemini API key is missing. Please add your API key to the CONFIG.API_KEY constant in the code.");
          }
          for (let i = 0; i < maxRetries; i++) {
              try {
                  const response = await fetch(CONFIG.GEMINI_API_URL + key, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify(payload)
                  });

                  if (response.ok) {
                      return await response.json();
                  }

                  if (response.status === 429 || response.status >= 500) {
                      await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                      continue; 
                  }

                  throw new Error(`API returned status code ${response.status}. Check API key and quota.`);

              } catch (error) {
                  if (i === maxRetries - 1) throw error; 
                  await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
              }
          }
          throw new Error("Failed to connect to Gemini API after multiple retries.");
      }

      async function generateCodeCultureProfile(personality, outputElement, buttonElement) {
          const name = state.answers[0] || 'Coder';
          
          const surveyAnswers = CONFIG.QUESTIONS.slice(2, CONFIG.QUESTIONS.length - 2).map((q, idx) => {
              const answerIndex = idx + 2; 
              const answerText = state.answers[answerIndex];
              return `Q${q.qIndex}: ${q.q} -> Answer: ${answerText}`;
          }).join('\n');

          let prompt = `Analyze the following ${ACTUAL_QUESTION_COUNT - 2} responses from a user named ${name} who completed a Code Culture survey. Based on their input, generate a concise, creative Code Culture Profile. The profile MUST start with a strong, unique title and then contain a brief (2-3 paragraph) analysis of their strengths, preferred work environment, and how they bridge the 'techy' vs 'creative' divide.

          User's Self-Identified Type (Q${CONFIG.QUESTIONS[CONFIG.QUESTIONS.length - 2].qIndex}): ${personality}

          --- Survey Responses ---
          ${surveyAnswers}
          -----------------------

          Format the output clearly using standard text (no markdown formatting like asterisks or symbols) and use line breaks for readability. Do not include the original questions or answers in the final profile.`;

          const systemPrompt = "You are a 'Code Culture Analyst', a thoughtful AI specializing in identifying and describing professional personas at the intersection of technology and creativity. Your goal is to provide insightful, non-judgemental, and engaging personality profiles. Respond using only standard text formatting, do not use markdown asterisks or symbols in your final output.";

          const payload = {
              contents: [{ parts: [{ text: prompt }] }],
              systemInstruction: { parts: [{ text: systemPrompt }] },
          };

          try {
              const result = await fetchGemini(payload);
              const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Analysis failed to generate a response.";
              
              outputElement.innerHTML = generatedText.replace(/\n/g, '<br>'); 

              buttonElement.innerHTML = '✨ Profile Generated!';
          } catch (error) {
              outputElement.innerHTML = `<p style="color: red; text-align: center;">Error: Could not generate profile. ${error.message}</p>`;
              
              if (error.message.includes("API key is missing")) {
                  const banner = document.getElementById('api-fix-banner');
                  if (banner) banner.style.display = 'block';
              }
              
              buttonElement.innerHTML = '✨ Retry Profile Generation';
              buttonElement.disabled = false;
          }
      }

      function displayValidationMessage(message) {
          const inputRow = document.querySelector('.input-row');
          let msgEl = document.getElementById('validation-msg');
          if (!msgEl) {
              msgEl = document.createElement('div');
              msgEl.id = 'validation-msg';
              msgEl.className = 'validation-message';
              inputRow.appendChild(msgEl);
          }
          msgEl.textContent = message;
          setTimeout(() => {
              if (msgEl) msgEl.textContent = '';
          }, 3000);
      }

      function handleNext() {
        const currentQ = CONFIG.QUESTIONS[state.index];
        let inputEl = document.querySelector('input[type="text"], input[type="email"], textarea');
        
        if (currentQ.type === "intro") {
            transitionScreen(1); 
            return;
        }

        if (currentQ.type === "options") {
          if (state.selectedOption) {
            state.answers[state.index] = state.selectedOption;
            state.selectedOption = null;
            transitionScreen(1);
          }
        } else {
          const inputValue = inputEl ? inputEl.value.trim() : '';

          if (!inputValue) {
            if (inputEl) {
                inputEl.style.animation = "shake 0.5s";
                setTimeout(() => inputEl.style.animation = "", 500);
            }
            displayValidationMessage("Please enter a value to continue.");
            return;
          }

          if (currentQ.inputType === 'email' && !isValidEmail(inputValue)) {
              if (inputEl) {
                  inputEl.style.animation = "shake 0.5s";
                  setTimeout(() => inputEl.style.animation = "", 500);
              }
              displayValidationMessage("Please enter a valid email address.");
              return;
          }

          state.answers[state.index] = inputValue;
          transitionScreen(1);
        }
      }
      
      function handleBack() {
          if (state.index > 0) {
              if (CONFIG.QUESTIONS[state.index - 1].type === 'options') {
                  state.selectedOption = state.answers[state.index - 1];
              }
              transitionScreen(-1);
          }
      }

      function transitionScreen(direction) {
        const exitDir = direction > 0 ? "left" : "right";
        const active = document.querySelector(".screen.active");
        
        if (active) {
          active.classList.remove("active");
          active.classList.add(`exit-${exitDir}`);
          setTimeout(() => {
            state.index += direction;
            showScreen(state.index);
          }, 600);
        }
      }

      function setupInputEvents(inputEl) {
        state.currentInput = inputEl;

        inputEl.addEventListener("keydown", e => {
          if (e.key === "Enter" && inputEl.tagName === 'INPUT') {
            e.preventDefault();
            handleNext();
          }
        });
        setTimeout(() => inputEl.focus(), 100);
      }
      
      function handleOptionClick(btn, option) {
        document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        state.selectedOption = option;
        
        setTimeout(() => handleNext(), 300);
      }

      function showScreen(i) {
        const currentQ = CONFIG.QUESTIONS[i];

        if (i >= CONFIG.QUESTIONS.length) {
          const bg = CONFIG.COLORS[Math.floor(Math.random() * CONFIG.COLORS.length)];
          const textColor = getContrastColor(bg);
          state.currentBg = bg;
          document.body.style.background = bg;

          const screen = document.createElement("div");
          screen.className = "screen active layout-center";
          screen.style.color = textColor;
          
          showResults(screen, textColor);
          state.container.innerHTML = "";
          state.container.appendChild(screen);
          return;
        }

        const bg = CONFIG.COLORS[Math.floor(Math.random() * CONFIG.COLORS.length)];
        const textColor = getContrastColor(bg);
        state.currentBg = bg;
        document.body.style.background = bg;

        const screen = document.createElement("div");
        screen.className = `screen active layout-${currentQ.layout}`;
        screen.style.color = textColor;
          
          let currentQNum = i; 
          if (i > 1) { 
            currentQNum = i - 1;
          } 
          
          const progress = document.createElement("div");
          progress.className = "progress";
          progress.textContent = `Question ${currentQNum}/${ACTUAL_QUESTION_COUNT}`;
          
          if (i > 0 && currentQ.type !== "intro") {
             screen.appendChild(progress);
          }

          if (currentQ.decoration !== "none") {
            screen.innerHTML += createDecoration(currentQ.decoration, textColor);
          }
          
          const mainContent = document.createElement("div");
          mainContent.className = "main-content";
          screen.appendChild(mainContent);

          if (currentQ.type === "intro") {
            const name = state.answers[0] ? state.answers[0].split(' ')[0] : 'there';
            
            const welcomeHeader = document.createElement("div");
            welcomeHeader.className = "result-header";
            welcomeHeader.textContent = `Welcome, ${name}!`;
            mainContent.appendChild(welcomeHeader);

            const introText = document.createElement("div");
            introText.className = "intro-text";
            introText.innerHTML = `This short survey is designed to explore the concepts of 'Creative' and 'Tech' cultures not through established rules, but through your personal opinion and approach to work. It's a way to define these concepts from several people's perspectives. <br><br>Your answers will be analyzed by an AI to provide a unique Code Culture Profile at the end.`;
            mainContent.appendChild(introText);
            
            const introBtn = document.createElement("button");
            introBtn.className = "btn";
            introBtn.textContent = "Start Survey";
            introBtn.style.borderColor = textColor;
            introBtn.style.color = textColor;
            introBtn.onclick = handleNext;
            mainContent.appendChild(introBtn);
            
            const navButtons = document.createElement("div");
            navButtons.className = "nav-buttons";
            navButtons.style.marginTop = "2rem";

            const backBtn = document.createElement("button");
            backBtn.id = "back-btn";
            backBtn.className = "btn";
            backBtn.textContent = "← Back";
            backBtn.style.borderColor = textColor;
            backBtn.style.color = textColor;
            backBtn.onclick = handleBack;
            navButtons.appendChild(backBtn);
            
            const dummyBtn = document.createElement("button");
            dummyBtn.className = "btn";
            dummyBtn.style.opacity = 0;
            dummyBtn.style.pointerEvents = 'none';
            navButtons.appendChild(dummyBtn);
            
            mainContent.appendChild(navButtons);

          } else {
            const questionText = document.createElement("div");
            questionText.className = "question-text";
            questionText.innerHTML = currentQ.q; 
            mainContent.appendChild(questionText);

            if (currentQ.showBall) {
              const ballContainer = document.createElement("div");
              ballContainer.style.display = 'flex';
              ballContainer.style.justifyContent = 'center';
              ballContainer.style.alignItems = 'center';
              ballContainer.innerHTML = `
                <svg id="bouncing-ball" viewBox="0 0 100 100">
                  <circle class="ball" cx="50" cy="70" r="15" fill="${textColor}"/>
                  <line x1="0" y1="90" x2="100" y2="90" stroke="${textColor}" stroke-width="2" opacity="0.3"/>
                </svg>
              `;
              mainContent.appendChild(ballContainer);
            }

            if (currentQ.type === "options") {
              const optionsGrid = document.createElement("div");
              optionsGrid.className = "options-grid";
              
              currentQ.options.forEach(option => {
                const btn = document.createElement("button");
                btn.className = "option-btn";
                btn.textContent = option;
                btn.style.borderColor = textColor;
                btn.style.color = textColor;
                btn.onclick = () => handleOptionClick(btn, option);
                if (state.answers[i] === option) {
                    btn.classList.add('selected');
                    state.selectedOption = option;
                }
                optionsGrid.appendChild(btn);
              });
              
              mainContent.appendChild(optionsGrid);
              
              const navButtons = document.createElement("div");
              navButtons.className = "nav-buttons";
              navButtons.style.marginTop = "2rem";

              const backBtn = document.createElement("button");
              backBtn.id = "back-btn";
              backBtn.className = "btn";
              backBtn.textContent = "← Back";
              backBtn.style.borderColor = textColor;
              backBtn.style.color = textColor;
              backBtn.onclick = handleBack;
              navButtons.appendChild(backBtn);
              
              const nextBtn = document.createElement("button");
              nextBtn.id = "next-btn";
              nextBtn.className = "btn";
              nextBtn.textContent = i === CONFIG.QUESTIONS.length - 1 ? "Results" : "Next →";
              nextBtn.style.borderColor = textColor;
              nextBtn.style.color = textColor;
              nextBtn.onclick = handleNext;
              navButtons.appendChild(nextBtn);
              
              mainContent.appendChild(navButtons);

            } else {
              const inputWrapper = document.createElement("div");
              inputWrapper.className = "input-row";
              inputWrapper.style.width = "100%";

              const inputEl = document.createElement(currentQ.inputType === "textarea" ? "textarea" : "input");
              inputEl.type = currentQ.inputType || "text";
              inputEl.placeholder = currentQ.placeholder;
              inputEl.style.color = textColor;

              if (state.answers[i]) inputEl.value = state.answers[i];
              inputWrapper.appendChild(inputEl);
              
              const msgEl = document.createElement('div');
              msgEl.id = 'validation-msg';
              msgEl.className = 'validation-message';
              inputWrapper.appendChild(msgEl);

              const navButtons = document.createElement("div");
              navButtons.className = "nav-buttons";
              navButtons.style.marginTop = "2rem";

              const backBtn = document.createElement("button");
              backBtn.id = "back-btn";
              backBtn.className = "btn";
              backBtn.textContent = "← Back";
              backBtn.style.borderColor = textColor;
              backBtn.style.color = textColor;
              backBtn.onclick = handleBack;
              navButtons.appendChild(backBtn);
              
              if (i === 0) backBtn.style.display = 'none';

              const nextBtn = document.createElement("button");
              nextBtn.id = "next-btn";
              nextBtn.className = "btn";
              nextBtn.textContent = i === CONFIG.QUESTIONS.length - 1 ? "Results" : "Next →";
              nextBtn.style.borderColor = textColor;
              nextBtn.style.color = textColor;
              nextBtn.onclick = handleNext;
              navButtons.appendChild(nextBtn);

              mainContent.appendChild(inputWrapper);
              mainContent.appendChild(navButtons);
              setupInputEvents(inputEl);
            }
          }

        state.container.innerHTML = "";
        state.container.appendChild(screen);
      }

      function showResults(screen, textColor) {
        screen.innerHTML += createDecoration("particles", textColor);
        
        const resultsDiv = document.createElement("div");
        resultsDiv.className = "results";
        resultsDiv.style.color = textColor;
        resultsDiv.style.textAlign = "center";
        resultsDiv.style.display = "flex";
        resultsDiv.style.flexDirection = "column";
        resultsDiv.style.justifyContent = "center";
        resultsDiv.style.alignItems = "center";
        resultsDiv.style.height = "100%";

        const header = document.createElement("div");
        header.className = "result-header";
        header.textContent = "Results & Analysis";
        resultsDiv.appendChild(header);

        const message = document.createElement("div");
        message.style.fontSize = "clamp(1.2rem, 3vw, 1.8rem)";
        message.style.marginBottom = "2rem";
        message.style.lineHeight = "1.6";
        message.style.maxWidth = "600px";
        message.style.opacity = "0.9";
        message.textContent = "Your core responses have been recorded via the webhook. Now, let's generate your custom Code Culture Profile!";
        resultsDiv.appendChild(message);

        const personality = state.answers[CONFIG.QUESTIONS.length - 2];
        
        saveResponses(personality);
        
        const analysisContainer = document.createElement("div");
        analysisContainer.style.maxWidth = "700px";
        analysisContainer.style.width = "100%";
        analysisContainer.style.marginBottom = "2rem";
        resultsDiv.appendChild(analysisContainer);

        const llmButton = document.createElement("button");
        llmButton.id = "generate-btn";
        llmButton.className = "btn";
        llmButton.innerHTML = "✨ Generate My Code Culture Profile";
        llmButton.style.marginTop = "1rem";
        analysisContainer.appendChild(llmButton);
      

        const profileOutput = document.createElement("div");
        profileOutput.id = "profile-output";
        profileOutput.style.marginTop = "2rem";
        profileOutput.style.color = textColor;
        profileOutput.style.background = `rgba(255, 255, 255, 0.1)`;
        profileOutput.style.borderColor = textColor;
        profileOutput.style.display = "none";
        
        analysisContainer.appendChild(profileOutput);

        llmButton.onclick = () => {
          llmButton.disabled = true;
          llmButton.textContent = "Analyzing... Hang Tight!";
          profileOutput.style.display = 'block';
          profileOutput.innerHTML = '<p style="text-align: center;">Analyzing your answers... please wait...</p>';
          generateCodeCultureProfile(personality, profileOutput, llmButton);
        };

        const restartBtn = document.createElement("button");
        restartBtn.className = "btn";
        restartBtn.textContent = "Take Survey Again";
        restartBtn.style.borderColor = textColor;
        restartBtn.style.color = textColor;
        restartBtn.style.marginTop = "2rem";
        restartBtn.onclick = () => {
          state.index = 0;
          state.answers = [];
          state.sessionId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
          showScreen(0);
        };
        resultsDiv.appendChild(restartBtn);

        screen.appendChild(resultsDiv);
        
        if (!CONFIG.API_KEY.trim()) {
            apiBanner.style.display = 'block';
        }
      }

      function init() {
          document.addEventListener('mousemove', (e) => createTrail(e.clientX, e.clientY));
          document.addEventListener('touchmove', (e) => {
              const touch = e.touches[0];
              createTrail(touch.clientX, touch.clientY);
          });
          
          showScreen(state.index);
      }

      init();
    })();
  </script>
</body>
</html>
